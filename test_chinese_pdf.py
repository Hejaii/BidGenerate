#!/usr/bin/env python3
"""
ä¸“é—¨æµ‹è¯•ä¸­æ–‡PDFç”Ÿæˆï¼Œç¡®ä¿ä¸­æ–‡å†…å®¹ä¸ä¹±ç 
"""

import tempfile
from pathlib import Path
from src.pdf_builder import build_pdf

def test_chinese_pdf_generation():
    """æµ‹è¯•ä¸­æ–‡PDFç”Ÿæˆæµç¨‹"""
    print("ğŸ§ª æµ‹è¯•ä¸­æ–‡PDFç”Ÿæˆæµç¨‹...")
    
    # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
    with tempfile.TemporaryDirectory() as temp_dir:
        temp_path = Path(temp_dir)
        work_dir = temp_path / "build_test"
        work_dir.mkdir()
        
        # åˆ›å»ºä¸­æ–‡æµ‹è¯•éœ€æ±‚æ–‡ä»¶
        requirements_file = temp_path / "ä¸­æ–‡æµ‹è¯•éœ€æ±‚.md"
        requirements_content = """# æ™ºèƒ½åŒ–è”ææœå›­ç®¡ç†ç³»ç»Ÿé¡¹ç›®éœ€æ±‚

## æŠ€æœ¯æ–¹æ¡ˆè¦æ±‚
- ç³»ç»Ÿæ¶æ„è®¾è®¡å¿…é¡»é‡‡ç”¨å¾®æœåŠ¡æ¶æ„
- æŠ€æœ¯é€‰å‹éœ€è¦è€ƒè™‘å¯æ‰©å±•æ€§å’Œç¨³å®šæ€§
- æ€§èƒ½æŒ‡æ ‡è¦è¾¾åˆ°é«˜å¹¶å‘å¤„ç†èƒ½åŠ›

## å®æ–½æ–¹æ¡ˆè¦æ±‚
- é¡¹ç›®è®¡åˆ’è¦è¯¦ç»†åˆ°æ¯ä¸ªé˜¶æ®µ
- èµ„æºé…ç½®è¦åˆç†åˆ†é…äººåŠ›ç‰©åŠ›
- è´¨é‡æ§åˆ¶è¦å»ºç«‹å®Œå–„çš„ç®¡ç†ä½“ç³»

## ç®¡ç†æ–¹æ¡ˆè¦æ±‚
- ç»„ç»‡æ¶æ„è¦æ¸…æ™°æ˜ç¡®èŒè´£åˆ†å·¥
- æ²Ÿé€šæœºåˆ¶è¦å»ºç«‹å®šæœŸæ±‡æŠ¥åˆ¶åº¦
- é£é™©ç®¡ç†è¦åˆ¶å®šåº”æ€¥é¢„æ¡ˆ
"""
        requirements_file.write_text(requirements_content, encoding="utf-8")
        
        # åˆ›å»ºä¸­æ–‡æµ‹è¯•çŸ¥è¯†åº“
        kb_dir = temp_path / "ä¸­æ–‡çŸ¥è¯†åº“"
        kb_dir.mkdir()
        
        # åˆ›å»ºä¸­æ–‡æŠ€æœ¯æ–‡æ¡£
        doc1 = kb_dir / "æŠ€æœ¯æ–¹æ¡ˆ.md"
        doc1.write_text("""# ç³»ç»Ÿæ¶æ„è®¾è®¡

æœ¬é¡¹ç›®é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

## å‰ç«¯å±‚
- Webç®¡ç†ç•Œé¢ï¼šæä¾›ç›´è§‚çš„ç”¨æˆ·æ“ä½œç•Œé¢
- ç§»åŠ¨ç«¯APPï¼šæ”¯æŒç§»åŠ¨è®¾å¤‡è®¿é—®
- æ•°æ®å¯è§†åŒ–å¤§å±ï¼šå®æ—¶å±•ç¤ºæœå›­çŠ¶æ€

## åº”ç”¨å±‚
- ä¸šåŠ¡é€»è¾‘æœåŠ¡ï¼šå¤„ç†æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- æ•°æ®å¤„ç†æœåŠ¡ï¼šè´Ÿè´£æ•°æ®æ¸…æ´—å’Œè½¬æ¢
- æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼šç¡®ä¿ç³»ç»Ÿé—´é€šä¿¡å¯é 

## æ•°æ®å±‚
- å…³ç³»å‹æ•°æ®åº“ï¼šå­˜å‚¨ç»“æ„åŒ–æ•°æ®
- æ—¶åºæ•°æ®åº“ï¼šå­˜å‚¨ä¼ æ„Ÿå™¨æ—¶åºæ•°æ®
- ç¼“å­˜ç³»ç»Ÿï¼šæé«˜æ•°æ®è®¿é—®æ€§èƒ½
""", encoding="utf-8")
        
        doc2 = kb_dir / "å®æ–½æ–¹æ¡ˆ.md"
        doc2.write_text("""# é¡¹ç›®è®¡åˆ’

## ç¬¬ä¸€é˜¶æ®µï¼šéœ€æ±‚åˆ†æï¼ˆ30å¤©ï¼‰
- éœ€æ±‚è°ƒç ”ï¼šæ·±å…¥äº†è§£å®¢æˆ·éœ€æ±‚
- éœ€æ±‚åˆ†æï¼šåˆ†ææŠ€æœ¯å¯è¡Œæ€§
- éœ€æ±‚ç¡®è®¤ï¼šä¸å®¢æˆ·ç¡®è®¤æœ€ç»ˆéœ€æ±‚

## ç¬¬äºŒé˜¶æ®µï¼šç³»ç»Ÿè®¾è®¡ï¼ˆ45å¤©ï¼‰
- æ¶æ„è®¾è®¡ï¼šè®¾è®¡ç³»ç»Ÿæ•´ä½“æ¶æ„
- è¯¦ç»†è®¾è®¡ï¼šè®¾è®¡å…·ä½“åŠŸèƒ½æ¨¡å—
- æ¥å£è®¾è®¡ï¼šè®¾è®¡ç³»ç»Ÿé—´æ¥å£è§„èŒƒ

## ç¬¬ä¸‰é˜¶æ®µï¼šå¼€å‘å®æ–½ï¼ˆ90å¤©ï¼‰
- ç¼–ç å¼€å‘ï¼šæŒ‰ç…§è®¾è®¡è¿›è¡Œç¼–ç 
- å•å…ƒæµ‹è¯•ï¼šç¡®ä¿ä»£ç è´¨é‡
- é›†æˆæµ‹è¯•ï¼šéªŒè¯ç³»ç»Ÿé›†æˆæ•ˆæœ
""", encoding="utf-8")
        
        doc3 = kb_dir / "ç®¡ç†æ–¹æ¡ˆ.md"
        doc3.write_text("""# ç»„ç»‡æ¶æ„

## é¡¹ç›®å›¢é˜Ÿ
- é¡¹ç›®ç»ç†ï¼šè´Ÿè´£é¡¹ç›®æ•´ä½“ç®¡ç†
- æŠ€æœ¯è´Ÿè´£äººï¼šè´Ÿè´£æŠ€æœ¯æ–¹æ¡ˆåˆ¶å®š
- å¼€å‘å·¥ç¨‹å¸ˆï¼šè´Ÿè´£å…·ä½“åŠŸèƒ½å¼€å‘
- æµ‹è¯•å·¥ç¨‹å¸ˆï¼šè´Ÿè´£è´¨é‡ä¿è¯

## æ²Ÿé€šæœºåˆ¶
- æ—¥å¸¸ç«™ä¼šï¼šæ¯æ—¥15åˆ†é’Ÿè¿›åº¦åŒæ­¥
- å‘¨ä¾‹ä¼šï¼šæ¯å‘¨æ€»ç»“å’Œä¸‹å‘¨è®¡åˆ’
- é‡Œç¨‹ç¢‘è¯„å®¡ï¼šå…³é”®èŠ‚ç‚¹è¯„å®¡ä¼šè®®
- å˜æ›´ç®¡ç†ï¼šå»ºç«‹å˜æ›´ç”³è¯·æµç¨‹
""", encoding="utf-8")
        
        # è¾“å‡ºPDFæ–‡ä»¶åˆ°å½“å‰ç›®å½•
        output_pdf = Path("./ä¸­æ–‡æµ‹è¯•PDF.pdf")
        
        try:
            print("   å¼€å§‹æ„å»ºä¸­æ–‡PDF...")
            print("   ä½¿ç”¨LLMè¿›è¡Œä¸­æ–‡å†…å®¹è§£æå’Œç”Ÿæˆ...")
            print(f"   è¾“å‡ºæ–‡ä»¶: {output_pdf.absolute()}")
            print("   å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡æ¨¡æ¿ç¡®ä¿ä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸...")
            
            # å¼ºåˆ¶æŒ‡å®šä½¿ç”¨ä¸­æ–‡æ¨¡æ¿
            chinese_template = Path("templates/main_compatible.tex")
            if not chinese_template.exists():
                chinese_template = Path("templates/main.tex")
            
            print(f"   ä½¿ç”¨æ¨¡æ¿: {chinese_template}")
            
            # è°ƒç”¨build_pdfï¼Œå¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡æ¨¡æ¿
            build_pdf(
                requirements=requirements_file,
                kb=kb_dir,
                out=output_pdf,
                latex_template=chinese_template,  # å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡æ¨¡æ¿
                workdir=work_dir,
                topk=3,
                use_llm=True  # å¯ç”¨LLMè°ƒç”¨
            )
            
            # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
            if output_pdf.exists() and output_pdf.stat().st_size > 0:
                print(f"âœ… ä¸­æ–‡PDFç”ŸæˆæˆåŠŸï¼æ–‡ä»¶å¤§å°: {output_pdf.stat().st_size} å­—èŠ‚")
                print(f"   æ–‡ä»¶ä½ç½®: {output_pdf.absolute()}")
                
                # æ£€æŸ¥å·¥ä½œç›®å½•ä¸­çš„æ–‡ä»¶
                print("   æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶:")
                for file_path in work_dir.rglob("*"):
                    if file_path.is_file():
                        rel_path = file_path.relative_to(work_dir)
                        size = file_path.stat().st_size
                        print(f"     {rel_path}: {size} å­—èŠ‚")
                
                return True
            else:
                print("âŒ ä¸­æ–‡PDFæ–‡ä»¶æœªç”Ÿæˆæˆ–ä¸ºç©º")
                return False
                
        except Exception as e:
            print(f"âŒ ä¸­æ–‡PDFç”Ÿæˆå¤±è´¥: {e}")
            return False

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ å¼€å§‹æµ‹è¯•ä¸­æ–‡PDFç”Ÿæˆæµç¨‹...\n")
    print("ğŸ“ æœ¬æ¬¡æµ‹è¯•ä¸“é—¨éªŒè¯ä¸­æ–‡å†…å®¹æ˜¾ç¤ºæ•ˆæœ")
    print("ğŸ”¤ ç¡®ä¿ä½¿ç”¨ä¸­æ–‡æ¨¡æ¿ï¼Œé¿å…è‹±æ–‡æ¨¡æ¿å¯¼è‡´çš„ä¸­æ–‡ä¹±ç é—®é¢˜\n")
    
    if test_chinese_pdf_generation():
        print("\nğŸ‰ ä¸­æ–‡PDFç”Ÿæˆæµ‹è¯•æˆåŠŸï¼")
        print("âœ… PDFæ–‡ä»¶å·²ä¿å­˜åˆ°å½“å‰ç›®å½•")
        print("âœ… ä½¿ç”¨ä¸­æ–‡æ¨¡æ¿ç¡®ä¿ä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸")
        print("âœ… å¯ä»¥ä½¿ç”¨ç³»ç»Ÿé»˜è®¤åº”ç”¨æ‰“å¼€PDFæ–‡ä»¶")
        
        # å°è¯•æ‰“å¼€PDFæ–‡ä»¶
        pdf_path = Path("./ä¸­æ–‡æµ‹è¯•PDF.pdf")
        if pdf_path.exists():
            print(f"\nğŸ“„ ä¸­æ–‡PDFæ–‡ä»¶å·²ç”Ÿæˆ: {pdf_path.absolute()}")
            print("ğŸ’¡ è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰“å¼€PDFæ–‡ä»¶:")
            print(f"   open {pdf_path}")
            print("\nğŸ” è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºä¸­æ–‡:")
            print("   - å°é¢æ ‡é¢˜å’Œé¡¹ç›®ä¿¡æ¯")
            print("   - ç›®å½•é¡µæ ‡é¢˜")
            print("   - æ­£æ–‡ä¸­çš„ä¸­æ–‡å†…å®¹")
            print("   - ç‰¹æ®Šä¸­æ–‡å­—ç¬¦ï¼ˆå¦‚ï¼šã€ç­‰ï¼‰")
    else:
        print("\nâŒ ä¸­æ–‡PDFç”Ÿæˆæµ‹è¯•å¤±è´¥")

if __name__ == "__main__":
    main()
